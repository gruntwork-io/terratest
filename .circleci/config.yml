env: &env
  environment:
    GRUNTWORK_INSTALLER_VERSION: v0.0.36
    MODULE_CI_VERSION: v0.46.0
    MODULE_GCP_CI_VERSION: v0.1.1
    MODULE_CI_CIRCLECI_HELPER_VERSION: v0.56.0
    TERRAFORM_VERSION: 1.5.7
    TOFU_VERSION: 1.8.0
    PACKER_VERSION: 1.10.0
    TERRAGRUNT_VERSION: v0.80.4  # Default version; terragrunt_test job overrides with v0.93.10
    OPA_VERSION: v1.1.0
    GO_VERSION: 1.21.1
    GO111MODULE: auto
    K8S_VERSION: v1.20.0  # Same as EKS
    MINIKUBE_VERSION: v1.22.0
    HELM_VERSION: v3.13.1
    KUBECONFIG: /home/circleci/.kube/config
    BIN_BUILD_PARALLELISM: 3
    MISE_VERSION: v2024.4.0
    # Mise ASDF defaults to using main.tf to determine the terraform version to use, so we need to
    # override this to use the .terraform-version file instead.
    ASDF_HASHICORP_TERRAFORM_VERSION_FILE: .terraform-version

defaults: &defaults
  machine:
    enabled: true
    image: ubuntu-2004:2022.10.1
  <<: *env

setup_minikube: &setup_minikube
  command: |
    sudo apt update -y
    sudo apt install -y conntrack
    setup-minikube --k8s-version "$K8S_VERSION" --minikube-version "$MINIKUBE_VERSION"

install_helm: &install_helm
  name: install helm
  command: |
    # install helm
    curl -Lo helm.tar.gz https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz
    tar -xvf helm.tar.gz
    chmod +x linux-amd64/helm
    sudo mv linux-amd64/helm /usr/local/bin/

install_gruntwork_utils: &install_gruntwork_utils
  name: install gruntwork utils
  command: |
    INSTALLER_URL="https://raw.githubusercontent.com/gruntwork-io/gruntwork-installer/${GRUNTWORK_INSTALLER_VERSION}/bootstrap-gruntwork-installer.sh"
    curl -Ls "$INSTALLER_URL" | bash /dev/stdin --version "${GRUNTWORK_INSTALLER_VERSION}"
    gruntwork-install --module-name "gruntwork-module-circleci-helpers" --repo "https://github.com/gruntwork-io/terraform-aws-ci" --tag "${MODULE_CI_CIRCLECI_HELPER_VERSION}"
    gruntwork-install --module-name "kubernetes-circleci-helpers" --repo "https://github.com/gruntwork-io/terraform-aws-ci" --tag "${MODULE_CI_VERSION}"
    gruntwork-install --module-name "gcp-helpers" --repo "https://github.com/gruntwork-io/terraform-google-ci" --tag "${MODULE_GCP_CI_VERSION}"
    configure-environment-for-gruntwork-module \
      --mise-version ${MISE_VERSION} \
      --terraform-version ${TERRAFORM_VERSION} \
      --terragrunt-version ${TERRAGRUNT_VERSION} \
      --packer-version ${PACKER_VERSION} \
      --go-version NONE

    # Install OPA
    echo "Installing OPA version ${OPA_VERSION}"
    curl -sLO "https://github.com/open-policy-agent/opa/releases/download/${OPA_VERSION}/opa_linux_amd64_static"
    chmod +x ./opa_linux_amd64_static
    sudo mv ./opa_linux_amd64_static /usr/local/bin/opa

    # Temporary fix for installing go - remove when we can update gruntwork-module-circleci-helpers to version with fix
    echo "Installing Go version ${GO_VERSION}"
    curl -O --silent --location --fail --show-error "https://golang.org/dl/go${GO_VERSION}.linux-amd64.tar.gz"
    sudo rm -rf /usr/local/go
    sudo tar -C /usr/local -xzf "go${GO_VERSION}.linux-amd64.tar.gz"
    sudo ln -s /usr/local/go/bin/go /usr/bin/go
    echo "The installed version of Go is now $(go version)"

install_tofu: &install_tofu
  name: Install OpenTofu
  command: |
    curl -L "https://github.com/opentofu/opentofu/releases/download/v${TOFU_VERSION}/tofu_${TOFU_VERSION}_linux_amd64.zip" -o tofu.zip
    unzip -o tofu.zip
    sudo install -m 0755 tofu /usr/local/bin/tofu
    rm -rf tofu
    rm -rf tofu.zip
    tofu --version

# Helper script for swapping terraform with tofu binary
# This creates a bash function that can be sourced and called in test jobs
setup_tofu_swap: &setup_tofu_swap
  name: Setup tofu binary swap
  command: |
    cat > /tmp/tofu_swap_helper.sh << 'EOF'
    swap_terraform_with_tofu() {
      # Setup trap to ensure terraform binary is always restored
      cleanup() {
        echo "Restoring original terraform binary..."
        sudo rm -f /usr/local/bin/terraform
        sudo mv /usr/local/bin/terraform.bak /usr/local/bin/terraform 2>/dev/null || true
      }
      trap cleanup EXIT

      # Create symlink so tofu is used as terraform
      sudo mv /usr/local/bin/terraform /usr/local/bin/terraform.bak
      sudo ln -s /usr/local/bin/tofu /usr/local/bin/terraform
    }
    EOF
    chmod +x /tmp/tofu_swap_helper.sh

install_docker_buildx: &install_docker_buildx
  name: install docker buildx
  command: |
    curl -sLO https://github.com/docker/buildx/releases/download/v0.6.1/buildx-v0.6.1.linux-amd64
    mkdir -p ~/.docker/cli-plugins
    mv buildx-v0.6.1.linux-amd64 ~/.docker/cli-plugins/docker-buildx
    chmod a+x ~/.docker/cli-plugins/docker-buildx

    # Verify buildx is available
    docker buildx create --use

configure_environment_for_gcp: &configure_environment_for_gcp
  name: configure environment for gcp
  command: |
    # install the Google Cloud SDK CLI
    install-gcloud

    # Make GCP Service Account credentials available as a file
    echo $GCLOUD_SERVICE_KEY > ${HOME}/gcloud-service-key.json
    echo 'export GOOGLE_APPLICATION_CREDENTIALS=${HOME}/gcloud-service-key.json' >> $BASH_ENV

    # Tell gcloud to use the credentials and set defaults
    echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
    gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
    gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}

version: 2
jobs:
  setup:
    <<: *env
    resource_class: xlarge
    docker:
      - image: cimg/python:3.10.2

    steps:
      - checkout
      # Restore Go module cache. v2 prefix invalidates old cache that used wrong path.
      # Fallback key (gomod-v2-) allows partial cache hits when go.sum changes.
      - restore_cache:
          keys:
            - gomod-v2-{{ checksum "go.sum" }}
            - gomod-v2-

      # Install gruntwork utilities
      - run:
          <<: *install_gruntwork_utils

      # Save Go module cache using modern Go modules path
      - save_cache:
          key: gomod-v2-{{ checksum "go.sum" }}
          paths:
            - $HOME/go/pkg/mod

      # The weird way you have to set PATH in Circle 2.0
      - run: |
          echo 'export PATH=$HOME/.local/bin:$HOME/go/bin:$HOME/terraform:$HOME/packer:$PATH' >> $BASH_ENV

      # Run pre-commit hooks and fail the build if any hook finds required changes.
      - run:
          name: run precommit
          command: |
            go install golang.org/x/tools/cmd/goimports@latest
            # Install the latest minor version for v2
            pip install pre-commit~=2.9
            pre-commit install
            pre-commit run --all-files

      # Build any binaries that need to be built
      # We always want to build the binaries to test that there are no compile failures. Also, we will use the
      # terratest_log_parser to parse out the test output during a failure. Finally, on releases, we'll push these
      # binaries to GitHub as release assets.
      - run:
          command: |
            # For some reason, the circleci environment requires additional module dependencies that are not captured by
            # our Linux or Mac OSX dev environments. We workaround this by running `go mod tidy` in the CircleCI
            # environment so it pulls in what it needs.
            go mod tidy

            go install github.com/mitchellh/gox@latest

            GO_ENABLED=0 build-go-binaries \
              --parallel "$BIN_BUILD_PARALLELISM" \
              --app-name terratest_log_parser \
              --src-path ./cmd/terratest_log_parser \
              --dest-path ./cmd/bin \
              --ld-flags "-X main.VERSION=$CIRCLE_TAG -extldflags '-static'"

            GO_ENABLED=0 build-go-binaries \
              --parallel "$BIN_BUILD_PARALLELISM" \
              --app-name pick-instance-type \
              --src-path ./cmd/pick-instance-type \
              --dest-path ./cmd/bin \
              --ld-flags "-X main.VERSION=$CIRCLE_TAG -extldflags '-static'"
          when: always

      - persist_to_workspace:
          root: /home/circleci
          paths:
            - project

  # run tests with both terraform and tofu binaries
  test_terraform:
    <<: *defaults
    resource_class: xlarge
    steps:
      - attach_workspace:
          at: /home/circleci

      - run:
          <<: *install_gruntwork_utils
      - run:
          <<: *install_tofu
      - run:
          <<: *setup_tofu_swap

      # The weird way you have to set PATH in Circle 2.0
      - run: |
          echo 'export PATH=$HOME/.local/bin:$HOME/terraform:$HOME/packer:$PATH' >> $BASH_ENV

      # Run the tests. Note that we set the "-p 1" flag to tell Go to run tests in each package sequentially. Without
      # this, Go buffers all log output until all packages are done, which with slower running tests can cause CircleCI
      # to kill the build after more than 10 minutes without log output.
      # NOTE: because this doesn't build with the kubernetes tag, it will not run the kubernetes tests. See
      # kubernetes_test build steps.
      # NOTE: terragrunt tests are excluded here and run in a separate terragrunt_test job.
      - run: mkdir -p /tmp/logs
      # check we can compile the azure code, but don't actually run the tests
      - run: run-go-tests --packages "-p 1 -tags=azure -run IDontExist ./modules/azure"

      # Run tests with terraform binary
      - run:
          name: Run tests with Terraform
          no_output_timeout: 30m
          command: |
            echo "========================================"
            echo "Running tests with Terraform $(terraform --version | head -1)"
            echo "========================================"
            run-go-tests --packages "-p 1 $(go list ./... | grep -v './modules/terragrunt' | tr '\n' ' ')" 2>&1 | tee /tmp/logs/test_output_terraform.log
            echo "Terraform tests completed"

      # Run tests with tofu binary
      - run:
          name: Run tests with OpenTofu
          no_output_timeout: 30m
          command: |
            source /tmp/tofu_swap_helper.sh
            swap_terraform_with_tofu

            echo "========================================"
            echo "Running tests with OpenTofu (as terraform): $(terraform --version | head -1)"
            echo "========================================"
            run-go-tests --packages "-p 1 $(go list ./... | grep -v './modules/terragrunt' | tr '\n' ' ')" 2>&1 | tee /tmp/logs/test_output_tofu.log
            echo "OpenTofu tests completed"

      - run:
          name: Parse test results
          command: |
            echo "Parsing Terraform test results..."
            ./cmd/bin/terratest_log_parser_linux_amd64 --testlog /tmp/logs/test_output_terraform.log --outputdir /tmp/logs/terraform || true
            echo "Parsing OpenTofu test results..."
            ./cmd/bin/terratest_log_parser_linux_amd64 --testlog /tmp/logs/test_output_tofu.log --outputdir /tmp/logs/tofu || true
          when: always

      # Store test result and log artifacts for browsing purposes
      - store_artifacts:
          path: /tmp/logs/terraform
          destination: test-results-terraform
      - store_artifacts:
          path: /tmp/logs/tofu
          destination: test-results-tofu
      - store_artifacts:
          path: /tmp/logs/test_output_terraform.log
          destination: raw-logs/terraform.log
      - store_artifacts:
          path: /tmp/logs/test_output_tofu.log
          destination: raw-logs/tofu.log
      - store_test_results:
          path: /tmp/logs/terraform
      - store_test_results:
          path: /tmp/logs/tofu

  # We run the GCP tests in a separate build step using the Docker executor for better isolation and resiliency. Using
  # The Docker executor ensures GCP tests do not erroneously make metadata network calls within CircleCI's private
  # environment. For more information see: https://github.com/gruntwork-io/terratest/pull/765.
  gcp_test:
    <<: *env
    docker:
      - image: cimg/base:2022.03

    steps:
      - attach_workspace:
          at: /home/circleci

      - run:
          <<: *install_gruntwork_utils

      # The weird way you have to set PATH in Circle 2.0
      - run: |
          echo 'export PATH=$HOME/.local/bin:$HOME/terraform:$HOME/packer:$PATH' >> $BASH_ENV

      - run:
          <<: *configure_environment_for_gcp

      # Run the GCP tests. These tests are run because the gcp build tag is included, and we explicitly
      # select the GCP tests
      - run:
          no_output_timeout: 30m
          command: |
            mkdir -p /tmp/logs
            # Run the unit tests first, then the integration tests. They are separate because the integration tests
            # require additional filtering.
            run-go-tests --packages "-p 1 -tags gcp ./modules/gcp" 2>&1 | tee /tmp/logs/test_output.log
            run-go-tests --packages "-p 1 -tags=gcp ./test/gcp" 2>&1 | tee -a /tmp/logs/test_output.log

      - run:
          command: |
            ./cmd/bin/terratest_log_parser_linux_amd64 --testlog /tmp/logs/test_output.log --outputdir /tmp/logs
          when: always

      # Store test result and log artifacts for browsing purposes
      - store_artifacts:
          path: /tmp/logs
      - store_test_results:
          path: /tmp/logs

  kubernetes_test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /home/circleci

      - run:
          <<: *install_gruntwork_utils

      # The weird way you have to set PATH in Circle 2.0
      - run: |
          echo 'export PATH=$HOME/.local/bin:$HOME/terraform:$HOME/packer:$PATH' >> $BASH_ENV

      - run:
          <<: *setup_minikube

      # Run the Kubernetes tests. These tests are run because the kubernetes build tag is included, and we explicitly
      # select the kubernetes tests
      - run:
          no_output_timeout: 30m
          command: |
            mkdir -p /tmp/logs
            # Run the unit tests first, then the integration tests. They are separate because the integration tests
            # require additional filtering.
            run-go-tests --packages "-p 1 -tags kubernetes ./modules/k8s" 2>&1 | tee /tmp/logs/test_output.log
            run-go-tests --packages "-p 1 -tags kubernetes -run TestKubernetes ./test" 2>&1 | tee -a /tmp/logs/test_output.log

      - run:
          command: |
            ./cmd/bin/terratest_log_parser_linux_amd64 --testlog /tmp/logs/test_output.log --outputdir /tmp/logs
          when: always

      # Store test result and log artifacts for browsing purposes
      - store_artifacts:
          path: /tmp/logs
      - store_test_results:
          path: /tmp/logs


  helm_test:
    <<: *defaults
    resource_class: large
    steps:
      - attach_workspace:
          at: /home/circleci

      - run:
          <<: *install_gruntwork_utils

      # The weird way you have to set PATH in Circle 2.0
      - run: |
          echo 'export PATH=$HOME/.local/bin:$HOME/terraform:$HOME/packer:$PATH' >> $BASH_ENV

      - run:
          <<: *setup_minikube

      - run:
          <<: *install_helm

      # Run the Helm tests. These tests are run because the helm build tag is included, and we explicitly
      # select the helm tests
      - run:
          no_output_timeout: 30m
          command: |
            mkdir -p /tmp/logs
            # Run the unit tests first, then the integration tests. They are separate because the integration tests
            # require additional filtering.
            run-go-tests --packages "-p 1 -tags helm ./modules/helm" 2>&1 | tee /tmp/logs/test_output.log
            run-go-tests --packages "-p 1 -tags helm -run TestHelm ./test" 2>&1 | tee -a /tmp/logs/test_output.log

      - run:
          command: |
            ./cmd/bin/terratest_log_parser_linux_amd64 --testlog /tmp/logs/test_output.log --outputdir /tmp/logs
          when: always

      # Store test result and log artifacts for browsing purposes
      - store_artifacts:
          path: /tmp/logs
      - store_test_results:
          path: /tmp/logs

  # Dedicated terragrunt tests with both terraform and tofu binaries
  # This job uses a newer terragrunt version (v0.93.10) to test forward compatibility
  terragrunt_test:
    <<: *defaults
    resource_class: large
    environment:
      TERRAGRUNT_VERSION: v0.93.10  # Dedicated version for terragrunt module tests
    steps:
      - attach_workspace:
          at: /home/circleci

      # Install gruntwork utils, which will use the TERRAGRUNT_VERSION from this job's environment
      - run:
          <<: *install_gruntwork_utils
      - run:
          <<: *install_tofu
      - run:
          <<: *setup_tofu_swap

      # The weird way you have to set PATH in Circle 2.0
      - run: |
          echo 'export PATH=$HOME/.local/bin:$HOME/terraform:$HOME/packer:$PATH' >> $BASH_ENV

      # Verify the correct terragrunt version is installed
      - run:
          name: Verify Terragrunt version
          command: |
            echo "Verifying Terragrunt version..."
            ACTUAL_VERSION=$(terragrunt --version 2>&1 | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1)
            echo "Expected version: ${TERRAGRUNT_VERSION}"
            echo "Actual version: ${ACTUAL_VERSION}"
            if [ "$ACTUAL_VERSION" != "${TERRAGRUNT_VERSION}" ]; then
              echo "ERROR: Terragrunt version mismatch!"
              exit 1
            fi
            echo "âœ“ Terragrunt version verified successfully"

      - run: mkdir -p /tmp/logs

      # Run terragrunt tests with terraform binary
      - run:
          name: Run terragrunt tests with Terraform
          no_output_timeout: 30m
          command: |
            echo "========================================"
            echo "Running terragrunt tests with Terraform $(terraform --version | head -1)"
            echo "Terragrunt version: $(terragrunt --version)"
            echo "========================================"
            run-go-tests --packages "-p 1 ./modules/terragrunt" 2>&1 | tee /tmp/logs/test_output_terraform.log
            echo "Terragrunt tests with Terraform completed"

      # Run terragrunt tests with tofu binary
      - run:
          name: Run terragrunt tests with OpenTofu
          no_output_timeout: 30m
          command: |
            source /tmp/tofu_swap_helper.sh
            swap_terraform_with_tofu

            echo "========================================"
            echo "Running terragrunt tests with OpenTofu (as terraform): $(terraform --version | head -1)"
            echo "Terragrunt version: $(terragrunt --version)"
            echo "========================================"
            run-go-tests --packages "-p 1 ./modules/terragrunt" 2>&1 | tee /tmp/logs/test_output_tofu.log
            echo "Terragrunt tests with OpenTofu completed"

      - run:
          name: Parse terragrunt test results
          command: |
            echo "Parsing Terraform test results..."
            ./cmd/bin/terratest_log_parser_linux_amd64 --testlog /tmp/logs/test_output_terraform.log --outputdir /tmp/logs/terraform || true
            echo "Parsing OpenTofu test results..."
            ./cmd/bin/terratest_log_parser_linux_amd64 --testlog /tmp/logs/test_output_tofu.log --outputdir /tmp/logs/tofu || true
          when: always

      # Store test result and log artifacts for browsing purposes
      - store_artifacts:
          path: /tmp/logs/terraform
          destination: terragrunt-test-results-terraform
      - store_artifacts:
          path: /tmp/logs/tofu
          destination: terragrunt-test-results-tofu
      - store_artifacts:
          path: /tmp/logs/test_output_terraform.log
          destination: terragrunt-raw-logs/terraform.log
      - store_artifacts:
          path: /tmp/logs/test_output_tofu.log
          destination: terragrunt-raw-logs/tofu.log
      - store_test_results:
          path: /tmp/logs/terraform
      - store_test_results:
          path: /tmp/logs/tofu

  deploy:
    <<: *defaults
    steps:
      - checkout
      - attach_workspace:
          at: /home/circleci
      - run: |
          INSTALLER_URL="https://raw.githubusercontent.com/gruntwork-io/gruntwork-installer/$GRUNTWORK_INSTALLER_VERSION/bootstrap-gruntwork-installer.sh"
          curl -Ls "$INSTALLER_URL" | bash /dev/stdin --version "$GRUNTWORK_INSTALLER_VERSION"
      - run: |
          gruntwork-install --module-name "gruntwork-module-circleci-helpers" --repo "https://github.com/gruntwork-io/terraform-aws-ci" --tag "$MODULE_CI_VERSION"
      - run: cd cmd/bin && sha256sum * > SHA256SUMS
      - run: upload-github-release-assets cmd/bin/*


workflows:
  version: 2
  build-and-test:
    jobs:
      - setup:
          context:
            - AWS__PHXDEVOPS__circle-ci-test
            - GITHUB__PAT__gruntwork-ci
          filters:
            tags:
              only: /^v.*/

      - kubernetes_test:
          context:
            - AWS__PHXDEVOPS__circle-ci-test
            - GITHUB__PAT__gruntwork-ci
          requires:
            - setup
          filters:
            tags:
              only: /^v.*/

      - helm_test:
          context:
            - AWS__PHXDEVOPS__circle-ci-test
            - GITHUB__PAT__gruntwork-ci
          requires:
            - setup
          filters:
            tags:
              only: /^v.*/

      - terragrunt_test:
          context:
            - AWS__PHXDEVOPS__circle-ci-test
            - GITHUB__PAT__gruntwork-ci
          requires:
            - setup
          filters:
            tags:
              only: /^v.*/

      - test_terraform:
          context:
            - AWS__PHXDEVOPS__circle-ci-test
            - GITHUB__PAT__gruntwork-ci
            - SLACK__TOKEN__refarch-deployer-test
            - SLACK__WEBHOOK__refarch-deployer-test
            - SLACK__CHANNEL__test-workflow-approvals
          requires:
            - setup
          filters:
            tags:
              only: /^v.*/

      - gcp_test:
          context:
            - GCP__automated-tests
            - GITHUB__PAT__gruntwork-ci
          requires:
            - setup
          filters:
            tags:
              only: /^v.*/

      - deploy:
          context:
            - AWS__PHXDEVOPS__circle-ci-test
            - GITHUB__PAT__gruntwork-ci
          requires:
            - setup
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
